# AI æ–‡ç« ç”Ÿæˆå·¥ä½œæµ
# 
# æ­¤å·¥ä½œæµç”±ç®¡ç†åå°ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ï¼Œæ”¯æŒï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
# 2. å®šæ—¶è§¦å‘ï¼ˆscheduleï¼‰
# 3. åç«¯ç³»ç»Ÿ API è§¦å‘
#
# æ”¯æŒçš„åŠŸèƒ½ï¼š
# - å•ç¯‡æ–‡ç« ç”Ÿæˆ
# - æ‰¹é‡å¤šç¯‡æ–‡ç« ç”Ÿæˆï¼ˆé€šè¿‡ batch_config å‚æ•°ï¼‰
# - å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ˆç³»ç»Ÿä¸­åˆ›å»ºä»»åŠ¡ï¼Œå®šæœŸæ‰§è¡Œï¼‰
#
# æ”¯æŒçš„ AI å¹³å°ï¼šOpenAI, Claude, é€šä¹‰åƒé—®, DeepSeek
# æ”¯æŒçš„å›¾ç‰‡æœåŠ¡ï¼šBing, Google, Unsplash, Pixabay + è‡ªå®šä¹‰å›¾ç‰‡æ± 

name: AI æ–‡ç« ç”Ÿæˆ

on:
  # æ‰‹åŠ¨è§¦å‘ / åç«¯ API è§¦å‘
  workflow_dispatch:
    inputs:
      # ===== æ‰¹é‡ç”Ÿæˆæ¨¡å¼ =====
      batch_mode:
        description: 'æ˜¯å¦æ‰¹é‡ç”Ÿæˆæ¨¡å¼'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      batch_config:
        description: 'æ‰¹é‡ç”Ÿæˆé…ç½® (JSON æ ¼å¼)'
        required: false
        type: string
      task_id:
        description: 'ä»»åŠ¡ ID (ç”±åç«¯ç³»ç»Ÿç”Ÿæˆï¼Œç”¨äºå›è°ƒ)'
        required: false
        type: string
      
      # ===== å•ç¯‡ç”Ÿæˆæ¨¡å¼ =====
      game_name:
        description: 'æ¸¸æˆåç§° (å•ç¯‡æ¨¡å¼)'
        required: false
        type: string
      category:
        description: 'æ¸¸æˆåˆ†ç±»'
        required: false
        type: choice
        options:
          - xianxia
          - chuanqi
          - sanguo
          - wuxia
          - xiyou
          - mohuan
          - qban
          - huihe
          - kapai
          - maoxian
          - fangzhi
          - gecao
          - dongman
          - erciyuan
          - celue
      template:
        description: 'æ–‡ç« æ¨¡æ¿'
        required: false
        default: 'game-intro'
        type: choice
        options:
          - game-intro
          - strategy
          - review
      
      # ===== é€šç”¨é…ç½® =====
      ai_provider:
        description: 'AI å¹³å°'
        required: false
        default: 'deepseek'
        type: choice
        options:
          - openai
          - claude
          - qwen
          - deepseek
      image_search_enabled:
        description: 'å¯ç”¨å›¾ç‰‡æœç´¢'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      image_search_engine:
        description: 'å›¾ç‰‡æœç´¢å¼•æ“'
        required: false
        default: 'unsplash'
        type: choice
        options:
          - unsplash
          - pixabay
          - bing
      webhook_url:
        description: 'å›è°ƒ Webhook URL'
        required: false
        type: string

  # å®šæ—¶è§¦å‘ï¼ˆç”±åç«¯é…ç½®çš„ Cron è¡¨è¾¾å¼æ§åˆ¶ï¼‰
  # æ³¨æ„ï¼šå®šæ—¶ä»»åŠ¡å»ºè®®é…åˆæ‰¹é‡æ¨¡å¼ä½¿ç”¨ï¼Œåœ¨ secrets ä¸­é…ç½® SCHEDULED_BATCH_CONFIG
  schedule:
    - cron: '0 18 * * *'  # UTC æ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2 ç‚¹

# æƒé™é…ç½®
permissions:
  contents: write

jobs:
  # ======================================
  # å‡†å¤‡é˜¶æ®µï¼šè§£æé…ç½®ï¼Œç”Ÿæˆä»»åŠ¡çŸ©é˜µ
  # ======================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      batch_mode: ${{ steps.set-matrix.outputs.batch_mode }}
      task_id: ${{ inputs.task_id || github.run_id }}
    steps:
      - name: è§£æç”Ÿæˆä»»åŠ¡
        id: set-matrix
        run: |
          if [[ "${{ inputs.batch_mode }}" == "true" && -n "${{ inputs.batch_config }}" ]]; then
            # æ‰¹é‡æ¨¡å¼ï¼šä» batch_config è§£æä»»åŠ¡åˆ—è¡¨
            echo "batch_mode=true" >> $GITHUB_OUTPUT
            
            # è§£æ JSON é…ç½®ï¼Œæå– tasks æ•°ç»„
            MATRIX=$(echo '${{ inputs.batch_config }}' | jq -c '{include: .tasks}')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            
            TASK_COUNT=$(echo '${{ inputs.batch_config }}' | jq '.tasks | length')
            echo "ğŸ“‹ æ‰¹é‡æ¨¡å¼ï¼šå‡†å¤‡ç”Ÿæˆ $TASK_COUNT ç¯‡æ–‡ç« "
            
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            # å®šæ—¶è§¦å‘ï¼šä» secrets è¯»å–é…ç½®
            echo "batch_mode=true" >> $GITHUB_OUTPUT
            
            if [[ -n "${{ secrets.SCHEDULED_BATCH_CONFIG }}" ]]; then
              MATRIX=$(echo '${{ secrets.SCHEDULED_BATCH_CONFIG }}' | jq -c '{include: .tasks}')
              echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            else
              # é»˜è®¤é…ç½®ç¤ºä¾‹
              echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
              echo "âš ï¸ æœªé…ç½® SCHEDULED_BATCH_CONFIGï¼Œè·³è¿‡å®šæ—¶ç”Ÿæˆ"
            fi
            
          else
            # å•ç¯‡æ¨¡å¼
            echo "batch_mode=false" >> $GITHUB_OUTPUT
            
            # æ„å»ºå•ä»»åŠ¡çŸ©é˜µ
            MATRIX=$(cat <<EOF
          {
            "include": [{
              "gameName": "${{ inputs.game_name }}",
              "category": "${{ inputs.category }}",
              "template": "${{ inputs.template || 'game-intro' }}"
            }]
          }
          EOF
          )
            echo "matrix=$(echo $MATRIX | jq -c '.')" >> $GITHUB_OUTPUT
            echo "ğŸ“ å•ç¯‡æ¨¡å¼ï¼šç”Ÿæˆ ${{ inputs.game_name }} æ–‡ç« "
          fi

  # ======================================
  # ç”Ÿæˆé˜¶æ®µï¼šå¹¶è¡Œ/ä¸²è¡Œç”Ÿæˆæ–‡ç« 
  # ======================================
  generate:
    needs: prepare
    if: ${{ needs.prepare.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 2  # æœ€å¤š 2 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œé¿å… API é™æµ
      fail-fast: false  # ä¸€ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç¡®å®š AI å¹³å°é…ç½®
        id: ai-config
        run: |
          # ä¼˜å…ˆä½¿ç”¨ä»»åŠ¡çº§é…ç½®ï¼Œå…¶æ¬¡ä½¿ç”¨å…¨å±€é…ç½®
          AI_PROVIDER="${{ matrix.aiProvider || inputs.ai_provider || 'deepseek' }}"
          echo "provider=$AI_PROVIDER" >> $GITHUB_OUTPUT
          
          case "$AI_PROVIDER" in
            openai)
              echo "key=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            claude)
              echo "key=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            qwen)
              echo "key=${{ secrets.DASHSCOPE_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            deepseek)
              echo "key=${{ secrets.DEEPSEEK_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ç¡®å®šå›¾ç‰‡æœç´¢é…ç½®
        id: image-config
        run: |
          IMAGE_ENGINE="${{ matrix.imageEngine || inputs.image_search_engine || 'unsplash' }}"
          echo "engine=$IMAGE_ENGINE" >> $GITHUB_OUTPUT
          
          case "$IMAGE_ENGINE" in
            unsplash)
              echo "key=${{ secrets.UNSPLASH_ACCESS_KEY }}" >> $GITHUB_OUTPUT
              ;;
            pixabay)
              echo "key=${{ secrets.PIXABAY_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
            bing)
              echo "key=${{ secrets.BING_SEARCH_API_KEY }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ç”Ÿæˆæ–‡ç«  - ${{ matrix.gameName }}
        id: generate
        uses: ./.github/actions/ai-article-generator
        with:
          ai-provider: ${{ steps.ai-config.outputs.provider }}
          api-key: ${{ steps.ai-config.outputs.key }}
          template: ${{ matrix.template || 'game-intro' }}
          game-name: ${{ matrix.gameName }}
          category: ${{ matrix.category }}
          output-path: 'src/docs/pojie'
          commit-changes: true
          commit-message: 'feat(docs): AI ç”Ÿæˆæ–‡ç«  - ${{ matrix.gameName }}'
          # å›¾ç‰‡é…ç½®
          image-search-enabled: ${{ matrix.imageEnabled || inputs.image_search_enabled || 'true' }}
          image-search-engine: ${{ steps.image-config.outputs.engine }}
          image-search-api-key: ${{ steps.image-config.outputs.key }}
          image-pool-url: ${{ secrets.IMAGE_POOL_URL }}
          image-upload-enabled: 'false'
          # è‡ªå®šä¹‰æç¤ºè¯
          custom-prompt: ${{ matrix.customPrompt || '' }}
          custom-keywords: ${{ matrix.keywords || '' }}
          # Webhook å›è°ƒï¼ˆæ¯ç¯‡æ–‡ç« å®Œæˆåå›è°ƒï¼‰
          webhook-url: ${{ inputs.webhook_url || secrets.BACKEND_WEBHOOK_URL }}
          webhook-secret: ${{ secrets.WEBHOOK_SECRET }}
          task-id: ${{ needs.prepare.outputs.task_id }}

      - name: è¾“å‡ºç»“æœ
        run: |
          echo "âœ… æ–‡ç« ç”Ÿæˆå®Œæˆï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æ¸¸æˆåç§°: ${{ matrix.gameName }}"
          echo "åˆ†ç±»: ${{ matrix.category }}"
          echo "æ¨¡æ¿: ${{ matrix.template }}"
          echo "AI å¹³å°: ${{ steps.ai-config.outputs.provider }}"
          echo "Token æ¶ˆè€—: ${{ steps.generate.outputs.total-tokens }}"
          echo "å¤„ç†å›¾ç‰‡: ${{ steps.generate.outputs.images-processed }} å¼ "
          echo "ç”Ÿæˆæ–‡ä»¶: ${{ steps.generate.outputs.generated-files }}"

  # ======================================
  # æ±‡æ€»é˜¶æ®µï¼šæ‰¹é‡ä»»åŠ¡å®Œæˆåæ±‡æ€»å›è°ƒ
  # ======================================
  summary:
    needs: [prepare, generate]
    if: always() && needs.prepare.outputs.batch_mode == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ±‡æ€»æ‰¹é‡ç”Ÿæˆç»“æœ
        run: |
          echo "ğŸ“Š æ‰¹é‡ç”Ÿæˆä»»åŠ¡æ±‡æ€»"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ä»»åŠ¡ ID: ${{ needs.prepare.outputs.task_id }}"
          echo "ç”ŸæˆçŠ¶æ€: ${{ needs.generate.result }}"
          echo "å®Œæˆæ—¶é—´: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: å‘é€æ±‡æ€»å›è°ƒ
        if: ${{ inputs.webhook_url || secrets.BACKEND_WEBHOOK_URL }}
        run: |
          WEBHOOK_URL="${{ inputs.webhook_url || secrets.BACKEND_WEBHOOK_URL }}"
          
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.WEBHOOK_SECRET }}" \
            -d '{
              "event": "batch_complete",
              "taskId": "${{ needs.prepare.outputs.task_id }}",
              "runId": "${{ github.run_id }}",
              "status": "${{ needs.generate.result }}",
              "completedAt": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
            }'
          
          echo "âœ… å·²å‘é€æ‰¹é‡å®Œæˆå›è°ƒ"
