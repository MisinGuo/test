# Sitemap å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¸šç•Œæœ€ä½³å®è·µ](#ä¸šç•Œæœ€ä½³å®è·µ)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
- [ä»£ç å®ç°](#ä»£ç å®ç°)
- [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
- [æäº¤æœç´¢å¼•æ“](#æäº¤æœç´¢å¼•æ“)

---

## æ¦‚è¿°

### ä¸ºä»€ä¹ˆéœ€è¦ Sitemap

Sitemapï¼ˆç«™ç‚¹åœ°å›¾ï¼‰æ˜¯ä¸€ä¸ª XML æ–‡ä»¶ï¼Œåˆ—å‡ºç½‘ç«™ä¸Šçš„æ‰€æœ‰é‡è¦é¡µé¢ï¼Œå¸®åŠ©æœç´¢å¼•æ“æ›´å¥½åœ°æŠ“å–å’Œç´¢å¼•ä½ çš„ç½‘ç«™ã€‚å¯¹äºå¤šè¯­è¨€ã€å¤§å‹å†…å®¹ç½‘ç«™å°¤ä¸ºé‡è¦ã€‚

### é¡¹ç›®ç‰¹ç‚¹åˆ†æ

ä½ çš„ GameBox é¡¹ç›®å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- âœ… **å¤šè¯­è¨€ç«™ç‚¹**ï¼šæ”¯æŒ zh-CNï¼ˆé»˜è®¤ï¼‰ã€zh-TWã€en-US
- âœ… **åŠ¨æ€å†…å®¹**ï¼šæ¸¸æˆã€ç›’å­ã€æ”»ç•¥æ–‡ç« ç­‰
- âœ… **å¤šå±‚è·¯ç”±**ï¼šé¦–é¡µã€åˆ—è¡¨é¡µã€è¯¦æƒ…é¡µã€åˆ†ç±»é¡µç­‰
- âœ… **å¤§é‡é¡µé¢**ï¼šé¢„è®¡æœ‰æ•°ç™¾åˆ°æ•°åƒä¸ªé¡µé¢éœ€è¦ç´¢å¼•

---

## ä¸šç•Œæœ€ä½³å®è·µ

### å¤§å‹ç½‘ç«™ Sitemap ç­–ç•¥

è®©æˆ‘ä»¬çœ‹çœ‹ä¸šç•Œé¢†å…ˆä¼ä¸šå¦‚ä½•æ„å»º Sitemapï¼š

#### 1. **Amazon/äº¬ä¸œæ¨¡å¼**ï¼ˆè¶…å¤§å‹ç”µå•†ï¼‰
```
sitemap.xml (ç´¢å¼•æ–‡ä»¶)
â”œâ”€â”€ sitemap-products-1.xml (å•†å“ 1-50000)
â”œâ”€â”€ sitemap-products-2.xml (å•†å“ 50001-100000)
â”œâ”€â”€ sitemap-categories.xml (åˆ†ç±»é¡µ)
â””â”€â”€ sitemap-static.xml (é™æ€é¡µé¢)
```
**ç‰¹ç‚¹**ï¼šæŒ‰å†…å®¹ç±»å‹å’Œæ•°é‡åˆ†ç‰‡ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 50000 æ¡ URL

#### 2. **Steam/Epic Games æ¨¡å¼**ï¼ˆæ¸¸æˆå¹³å°ï¼‰
```
sitemap.xml (ç´¢å¼•æ–‡ä»¶)
â”œâ”€â”€ sitemap-games.xml (æ¸¸æˆåˆ—è¡¨)
â”œâ”€â”€ sitemap-dlc.xml (DLC/æ‰©å±•)
â”œâ”€â”€ sitemap-news.xml (æ–°é—»/æ”»ç•¥)
â””â”€â”€ sitemap-pages.xml (é™æ€é¡µé¢)
```
**ç‰¹ç‚¹**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼Œæ¸…æ™°çš„å±‚çº§ç»“æ„

#### 3. **Medium/æ˜é‡‘æ¨¡å¼**ï¼ˆå†…å®¹å¹³å°ï¼‰
```
sitemap.xml (ç´¢å¼•æ–‡ä»¶)
â”œâ”€â”€ sitemap-zh-CN.xml (ç®€ä½“ä¸­æ–‡ç´¢å¼•)
â”‚   â”œâ”€â”€ sitemap-zh-CN-articles-1.xml
â”‚   â”œâ”€â”€ sitemap-zh-CN-articles-2.xml
â”‚   â””â”€â”€ sitemap-zh-CN-static.xml
â”œâ”€â”€ sitemap-en.xml (è‹±æ–‡ç´¢å¼•)
â”‚   â”œâ”€â”€ sitemap-en-articles-1.xml
â”‚   â””â”€â”€ sitemap-en-static.xml
```
**ç‰¹ç‚¹**ï¼šæŒ‰è¯­è¨€åˆ†å±‚ï¼Œæ¯ä¸ªè¯­è¨€æœ‰ç‹¬ç«‹çš„å­ç´¢å¼•

### å…³é”®è®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**ï¼šä¸» sitemap â†’ è¯­è¨€ç´¢å¼• â†’ å†…å®¹ç±»å‹ â†’ å…·ä½“ URL
2. **æ•°é‡é™åˆ¶**ï¼šå•ä¸ª sitemap æ–‡ä»¶ä¸è¶…è¿‡ 50,000 ä¸ª URLï¼Œå¤§å°ä¸è¶…è¿‡ 50MB
3. **æ›´æ–°é¢‘ç‡**ï¼šæ ¹æ®å†…å®¹æ›´æ–°é¢‘ç‡è®¾ç½® `changefreq` å’Œ `priority`
4. **å¤šè¯­è¨€å¤„ç†**ï¼šä½¿ç”¨ `<xhtml:link rel="alternate" hreflang="xx">` æ ‡è®°
5. **åŠ¨æ€ç”Ÿæˆ**ï¼šåŸºäºæ•°æ®åº“å†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œè€Œéé™æ€æ–‡ä»¶

---

## æ¶æ„è®¾è®¡

### é’ˆå¯¹ GameBox çš„ Sitemap æ¶æ„

æ ¹æ®ä½ çš„é¡¹ç›®ç»“æ„ï¼Œæ¨èé‡‡ç”¨**ä¸‰å±‚æ¶æ„**ï¼š

```
sitemap.xml (ä¸»ç´¢å¼•)
â”œâ”€â”€ sitemap-zh-CN.xml (ç®€ä½“ä¸­æ–‡ç´¢å¼•)
â”‚   â”œâ”€â”€ sitemap-zh-CN-static.xml (é™æ€é¡µé¢ï¼šé¦–é¡µã€å…³äºç­‰)
â”‚   â”œâ”€â”€ sitemap-zh-CN-games.xml (æ¸¸æˆåˆ—è¡¨å’Œè¯¦æƒ…)
â”‚   â”œâ”€â”€ sitemap-zh-CN-boxes.xml (ç›’å­åˆ—è¡¨å’Œè¯¦æƒ…)
â”‚   â””â”€â”€ sitemap-zh-CN-strategy.xml (æ”»ç•¥æ–‡ç« )
â”œâ”€â”€ sitemap-zh-TW.xml (ç¹ä½“ä¸­æ–‡ç´¢å¼•)
â”‚   â”œâ”€â”€ sitemap-zh-TW-static.xml
â”‚   â”œâ”€â”€ sitemap-zh-TW-games.xml
â”‚   â”œâ”€â”€ sitemap-zh-TW-boxes.xml
â”‚   â””â”€â”€ sitemap-zh-TW-strategy.xml
â””â”€â”€ sitemap-en-US.xml (è‹±æ–‡ç´¢å¼•)
    â”œâ”€â”€ sitemap-en-US-static.xml
    â”œâ”€â”€ sitemap-en-US-games.xml
    â”œâ”€â”€ sitemap-en-US-boxes.xml
    â””â”€â”€ sitemap-en-US-strategy.xml
```

### è·¯ç”±æ˜ å°„è¡¨

| å†…å®¹ç±»å‹ | è·¯ç”±æ¨¡å¼ | Sitemap æ–‡ä»¶ | æ›´æ–°é¢‘ç‡ | ä¼˜å…ˆçº§ |
|---------|---------|-------------|---------|--------|
| é¦–é¡µ | `/` | static | daily | 1.0 |
| æ¸¸æˆåˆ—è¡¨ | `/games` | games | daily | 0.9 |
| æ¸¸æˆè¯¦æƒ… | `/games/[id]` | games | weekly | 0.8 |
| æ¸¸æˆåˆ†ç±» | `/games/category/[id]` | games | weekly | 0.7 |
| ç›’å­åˆ—è¡¨ | `/boxes` | boxes | daily | 0.9 |
| ç›’å­è¯¦æƒ… | `/boxes/[id]` | boxes | weekly | 0.8 |
| ç›’å­ä¸‹è½½é¡µ | `/boxes/[id]/download` | boxes | weekly | 0.7 |
| æ”»ç•¥åˆ—è¡¨ | `/strategy` | strategy | daily | 0.8 |
| æ”»ç•¥è¯¦æƒ… | `/strategy/[slug]` | strategy | monthly | 0.7 |
| æœç´¢é¡µ | `/search` | - | noindex | - |

### å¤šè¯­è¨€ URL ç¤ºä¾‹

```xml
<!-- ç®€ä½“ä¸­æ–‡ï¼ˆé»˜è®¤ï¼Œæ— å‰ç¼€ï¼‰ -->
<url>
  <loc>https://gamebox.example.com/games/123</loc>
  <xhtml:link rel="alternate" hreflang="zh-CN" href="https://gamebox.example.com/games/123"/>
  <xhtml:link rel="alternate" hreflang="zh-TW" href="https://gamebox.example.com/zh-TW/games/123"/>
  <xhtml:link rel="alternate" hreflang="en-US" href="https://gamebox.example.com/en-US/games/123"/>
  <xhtml:link rel="alternate" hreflang="x-default" href="https://gamebox.example.com/games/123"/>
</url>
```

---

## å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡å·¥ä½œï¼ˆ1å°æ—¶ï¼‰

#### 1. å®‰è£…ä¾èµ–ï¼ˆå¯é€‰ï¼‰

è™½ç„¶ Next.js æœ‰å†…ç½®çš„ sitemap æ”¯æŒï¼Œä½†ä¸ºäº†æ›´çµæ´»çš„æ§åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨å®ç°ï¼š

```bash
# å¦‚æœéœ€è¦ XML æ„å»ºå·¥å…·
npm install fast-xml-parser
```

#### 2. åˆ›å»ºé…ç½®æ–‡ä»¶

åœ¨ `src/config/sitemap/` åˆ›å»ºé…ç½®ï¼š

```typescript
// src/config/sitemap/config.ts
export const sitemapConfig = {
  // åŸºç¡€é…ç½®
  hostname: 'https://gamebox.example.com',
  
  // å•ä¸ª sitemap çš„æœ€å¤§ URL æ•°é‡ï¼ˆGoogle é™åˆ¶ 50000ï¼‰
  maxUrlsPerSitemap: 45000,
  
  // å†…å®¹ç±»å‹é…ç½®
  contentTypes: {
    static: {
      changefreq: 'daily',
      priority: 1.0,
    },
    games: {
      changefreq: 'weekly',
      priority: 0.8,
    },
    boxes: {
      changefreq: 'weekly',
      priority: 0.8,
    },
    strategy: {
      changefreq: 'monthly',
      priority: 0.7,
    },
  },
  
  // æ’é™¤çš„è·¯ç”±
  excludePatterns: [
    '/search',
    '/api/*',
    '/_next/*',
    '/admin/*',
  ],
}
```

### ç¬¬äºŒé˜¶æ®µï¼šå®ç°æ ¸å¿ƒé€»è¾‘ï¼ˆ3-4å°æ—¶ï¼‰

#### 1. åˆ›å»º Sitemap ç”Ÿæˆå™¨

```
src/lib/sitemap/
â”œâ”€â”€ types.ts           # ç±»å‹å®šä¹‰
â”œâ”€â”€ generator.ts       # æ ¸å¿ƒç”Ÿæˆé€»è¾‘
â”œâ”€â”€ formatters.ts      # XML æ ¼å¼åŒ–
â””â”€â”€ fetchers.ts        # æ•°æ®è·å–
```

#### 2. å®ç°ä¸» Sitemap

åœ¨ `src/app/` åˆ›å»ºè·¯ç”±å¤„ç†å™¨ï¼š

```
src/app/
â”œâ”€â”€ sitemap.xml/
â”‚   â””â”€â”€ route.ts       # ä¸»ç´¢å¼•
â”œâ”€â”€ sitemap-[locale].xml/
â”‚   â””â”€â”€ route.ts       # è¯­è¨€ç´¢å¼•
â””â”€â”€ sitemap-[locale]-[type].xml/
    â””â”€â”€ route.ts       # å†…å®¹ç±»å‹ sitemap
```

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®é›†æˆï¼ˆ2-3å°æ—¶ï¼‰

#### 1. è¿æ¥ API
- ä»ç°æœ‰ API è·å–æ¸¸æˆã€ç›’å­ã€æ”»ç•¥æ•°æ®
- è·å–æ¯ä¸ªå†…å®¹çš„ IDã€slugã€æ›´æ–°æ—¶é—´

#### 2. å¤„ç†å¤šè¯­è¨€
- ä¸ºæ¯ä¸ª URL ç”Ÿæˆæ‰€æœ‰è¯­è¨€å˜ä½“
- æ·»åŠ  hreflang æ ‡ç­¾

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ä¼˜åŒ–ï¼ˆ1-2å°æ—¶ï¼‰

#### 1. æœ¬åœ°æµ‹è¯•
#### 2. éªŒè¯ XML æ ¼å¼
#### 3. æ€§èƒ½ä¼˜åŒ–

---

## ä»£ç å®ç°

### 1. ç±»å‹å®šä¹‰

```typescript
// src/lib/sitemap/types.ts
export interface SitemapUrl {
  loc: string
  lastmod?: string
  changefreq?: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never'
  priority?: number
  alternates?: {
    locale: string
    href: string
  }[]
}

export interface SitemapConfig {
  hostname: string
  maxUrlsPerSitemap: number
  contentTypes: Record<string, {
    changefreq: string
    priority: number
  }>
}

export type ContentType = 'static' | 'games' | 'boxes' | 'strategy'
```

### 2. æ ¸å¿ƒç”Ÿæˆå™¨

```typescript
// src/lib/sitemap/generator.ts
import { supportedLocales, defaultLocale } from '@/config'
import { sitemapConfig } from '@/config/sitemap/config'
import type { SitemapUrl, ContentType } from './types'

/**
 * ç”Ÿæˆä¸» sitemap ç´¢å¼•
 */
export function generateSitemapIndex(): string {
  const { hostname } = sitemapConfig
  const lastmod = new Date().toISOString()
  
  const localesSitemaps = supportedLocales.map(locale => {
    const localePrefix = locale === defaultLocale ? '' : `/${locale}`
    return `
    <sitemap>
      <loc>${hostname}/sitemap-${locale}.xml</loc>
      <lastmod>${lastmod}</lastmod>
    </sitemap>`
  }).join('')
  
  return `<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  ${localesSitemaps}
</sitemapindex>`
}

/**
 * ç”Ÿæˆè¯­è¨€ç´¢å¼•
 */
export function generateLocaleIndex(locale: string): string {
  const { hostname } = sitemapConfig
  const lastmod = new Date().toISOString()
  const contentTypes: ContentType[] = ['static', 'games', 'boxes', 'strategy']
  
  const typeSitemaps = contentTypes.map(type => `
    <sitemap>
      <loc>${hostname}/sitemap-${locale}-${type}.xml</loc>
      <lastmod>${lastmod}</lastmod>
    </sitemap>`
  ).join('')
  
  return `<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  ${typeSitemaps}
</sitemapindex>`
}

/**
 * ç”Ÿæˆå†…å®¹ç±»å‹ sitemap
 */
export function generateContentSitemap(
  urls: SitemapUrl[],
  locale: string,
  type: ContentType
): string {
  const urlsXml = urls.map(url => formatSitemapUrl(url)).join('')
  
  return `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml">
  ${urlsXml}
</urlset>`
}

/**
 * æ ¼å¼åŒ–å•ä¸ª URL
 */
function formatSitemapUrl(url: SitemapUrl): string {
  const alternates = url.alternates?.map(alt => 
    `<xhtml:link rel="alternate" hreflang="${alt.locale}" href="${alt.href}"/>`
  ).join('\n    ') || ''
  
  return `
  <url>
    <loc>${url.loc}</loc>
    ${url.lastmod ? `<lastmod>${url.lastmod}</lastmod>` : ''}
    ${url.changefreq ? `<changefreq>${url.changefreq}</changefreq>` : ''}
    ${url.priority ? `<priority>${url.priority}</priority>` : ''}
    ${alternates}
  </url>`
}

/**
 * ç”Ÿæˆå¤šè¯­è¨€ URL å˜ä½“
 */
export function generateAlternateUrls(
  path: string,
  hostname: string
): { locale: string; href: string }[] {
  return supportedLocales.map(locale => {
    const localePrefix = locale === defaultLocale ? '' : `/${locale}`
    return {
      locale,
      href: `${hostname}${localePrefix}${path}`
    }
  })
}
```

### 3. æ•°æ®è·å–å™¨

```typescript
// src/lib/sitemap/fetchers.ts
import { api } from '@/lib/api'
import type { SitemapUrl, ContentType } from './types'
import { sitemapConfig } from '@/config/sitemap/config'
import { generateAlternateUrls } from './generator'

const { hostname, contentTypes } = sitemapConfig

/**
 * è·å–é™æ€é¡µé¢ URLs
 */
export async function fetchStaticUrls(locale: string): Promise<SitemapUrl[]> {
  const staticPaths = [
    '/',
    '/games',
    '/boxes',
    '/strategy',
  ]
  
  const config = contentTypes.static
  const localePrefix = locale === 'zh-CN' ? '' : `/${locale}`
  
  return staticPaths.map(path => ({
    loc: `${hostname}${localePrefix}${path}`,
    lastmod: new Date().toISOString(),
    changefreq: config.changefreq as any,
    priority: config.priority,
    alternates: generateAlternateUrls(path, hostname),
  }))
}

/**
 * è·å–æ¸¸æˆ URLs
 */
export async function fetchGameUrls(locale: string): Promise<SitemapUrl[]> {
  try {
    // ä» API è·å–æ‰€æœ‰æ¸¸æˆ
    const response = await api.games.list({
      locale,
      pageNum: 1,
      pageSize: 10000, // è·å–æ‰€æœ‰
    })
    
    const games = response.rows || []
    const config = contentTypes.games
    const localePrefix = locale === 'zh-CN' ? '' : `/${locale}`
    
    const urls: SitemapUrl[] = []
    
    // æ¸¸æˆè¯¦æƒ…é¡µ
    for (const game of games) {
      const path = `/games/${game.id}`
      urls.push({
        loc: `${hostname}${localePrefix}${path}`,
        lastmod: game.updateTime || new Date().toISOString(),
        changefreq: config.changefreq as any,
        priority: config.priority,
        alternates: generateAlternateUrls(path, hostname),
      })
    }
    
    // æ¸¸æˆåˆ†ç±»é¡µ
    const categories = await api.games.categories({ locale })
    for (const category of categories.data || []) {
      const path = `/games/category/${category.id}`
      urls.push({
        loc: `${hostname}${localePrefix}${path}`,
        lastmod: new Date().toISOString(),
        changefreq: 'weekly' as any,
        priority: 0.7,
        alternates: generateAlternateUrls(path, hostname),
      })
    }
    
    return urls
  } catch (error) {
    console.error('Error fetching game URLs:', error)
    return []
  }
}

/**
 * è·å–ç›’å­ URLs
 */
export async function fetchBoxUrls(locale: string): Promise<SitemapUrl[]> {
  try {
    const response = await api.boxes.list({
      locale,
      pageNum: 1,
      pageSize: 10000,
    })
    
    const boxes = response.rows || []
    const config = contentTypes.boxes
    const localePrefix = locale === 'zh-CN' ? '' : `/${locale}`
    
    const urls: SitemapUrl[] = []
    
    for (const box of boxes) {
      // ç›’å­è¯¦æƒ…é¡µ
      const detailPath = `/boxes/${box.id}`
      urls.push({
        loc: `${hostname}${localePrefix}${detailPath}`,
        lastmod: box.updateTime || new Date().toISOString(),
        changefreq: config.changefreq as any,
        priority: config.priority,
        alternates: generateAlternateUrls(detailPath, hostname),
      })
      
      // ç›’å­ä¸‹è½½é¡µ
      const downloadPath = `/boxes/${box.id}/download`
      urls.push({
        loc: `${hostname}${localePrefix}${downloadPath}`,
        lastmod: box.updateTime || new Date().toISOString(),
        changefreq: config.changefreq as any,
        priority: 0.7,
        alternates: generateAlternateUrls(downloadPath, hostname),
      })
    }
    
    return urls
  } catch (error) {
    console.error('Error fetching box URLs:', error)
    return []
  }
}

/**
 * è·å–æ”»ç•¥æ–‡ç«  URLs
 */
export async function fetchStrategyUrls(locale: string): Promise<SitemapUrl[]> {
  try {
    const response = await api.articles.list({
      locale,
      pageNum: 1,
      pageSize: 10000,
    })
    
    const articles = response.rows || []
    const config = contentTypes.strategy
    const localePrefix = locale === 'zh-CN' ? '' : `/${locale}`
    
    return articles.map(article => {
      const path = `/strategy/${article.slug || article.id}`
      return {
        loc: `${hostname}${localePrefix}${path}`,
        lastmod: article.updateTime || new Date().toISOString(),
        changefreq: config.changefreq as any,
        priority: config.priority,
        alternates: generateAlternateUrls(path, hostname),
      }
    })
  } catch (error) {
    console.error('Error fetching strategy URLs:', error)
    return []
  }
}

/**
 * æ ¹æ®ç±»å‹è·å– URLs
 */
export async function fetchUrlsByType(
  locale: string,
  type: ContentType
): Promise<SitemapUrl[]> {
  switch (type) {
    case 'static':
      return fetchStaticUrls(locale)
    case 'games':
      return fetchGameUrls(locale)
    case 'boxes':
      return fetchBoxUrls(locale)
    case 'strategy':
      return fetchStrategyUrls(locale)
    default:
      return []
  }
}
```

### 4. è·¯ç”±å¤„ç†å™¨

```typescript
// src/app/sitemap.xml/route.ts
import { NextResponse } from 'next/server'
import { generateSitemapIndex } from '@/lib/sitemap/generator'

export const dynamic = 'force-dynamic'
export const revalidate = 3600 // 1å°æ—¶é‡æ–°ç”Ÿæˆ

export async function GET() {
  try {
    const xml = generateSitemapIndex()
    
    return new NextResponse(xml, {
      headers: {
        'Content-Type': 'application/xml',
        'Cache-Control': 'public, max-age=3600, s-maxage=3600',
      },
    })
  } catch (error) {
    console.error('Error generating sitemap index:', error)
    return new NextResponse('Error generating sitemap', { status: 500 })
  }
}
```

```typescript
// src/app/sitemap-[locale].xml/route.ts
import { NextResponse } from 'next/server'
import { supportedLocales } from '@/config'
import { generateLocaleIndex } from '@/lib/sitemap/generator'

export const dynamic = 'force-dynamic'
export const revalidate = 3600

export async function GET(
  request: Request,
  { params }: { params: { locale: string } }
) {
  const { locale } = params
  
  // éªŒè¯è¯­è¨€
  if (!supportedLocales.includes(locale as any)) {
    return new NextResponse('Invalid locale', { status: 404 })
  }
  
  try {
    const xml = generateLocaleIndex(locale)
    
    return new NextResponse(xml, {
      headers: {
        'Content-Type': 'application/xml',
        'Cache-Control': 'public, max-age=3600, s-maxage=3600',
      },
    })
  } catch (error) {
    console.error('Error generating locale index:', error)
    return new NextResponse('Error generating sitemap', { status: 500 })
  }
}
```

```typescript
// src/app/sitemap-[locale]-[type].xml/route.ts
import { NextResponse } from 'next/server'
import { supportedLocales } from '@/config'
import { generateContentSitemap } from '@/lib/sitemap/generator'
import { fetchUrlsByType } from '@/lib/sitemap/fetchers'
import type { ContentType } from '@/lib/sitemap/types'

export const dynamic = 'force-dynamic'
export const revalidate = 3600

const validTypes: ContentType[] = ['static', 'games', 'boxes', 'strategy']

export async function GET(
  request: Request,
  { params }: { params: { locale: string; type: string } }
) {
  const { locale, type } = params
  
  // éªŒè¯å‚æ•°
  if (!supportedLocales.includes(locale as any)) {
    return new NextResponse('Invalid locale', { status: 404 })
  }
  if (!validTypes.includes(type as ContentType)) {
    return new NextResponse('Invalid content type', { status: 404 })
  }
  
  try {
    // è·å– URLs
    const urls = await fetchUrlsByType(locale, type as ContentType)
    
    // ç”Ÿæˆ XML
    const xml = generateContentSitemap(urls, locale, type as ContentType)
    
    return new NextResponse(xml, {
      headers: {
        'Content-Type': 'application/xml',
        'Cache-Control': 'public, max-age=3600, s-maxage=3600',
      },
    })
  } catch (error) {
    console.error(`Error generating sitemap for ${locale}-${type}:`, error)
    return new NextResponse('Error generating sitemap', { status: 500 })
  }
}
```

### 5. é…ç½®æ–‡ä»¶

```typescript
// src/config/sitemap/config.ts
import { siteConfig } from '../site/site'

export const sitemapConfig = {
  hostname: siteConfig.hostname,
  maxUrlsPerSitemap: 45000,
  
  contentTypes: {
    static: {
      changefreq: 'daily',
      priority: 1.0,
    },
    games: {
      changefreq: 'weekly',
      priority: 0.8,
    },
    boxes: {
      changefreq: 'weekly',
      priority: 0.8,
    },
    strategy: {
      changefreq: 'monthly',
      priority: 0.7,
    },
  },
  
  excludePatterns: [
    '/search',
    '/api/*',
    '/_next/*',
  ],
}
```

### 6. æ›´æ–° middlewareï¼ˆå¦‚éœ€è¦ï¼‰

```typescript
// src/middleware.ts
// ç¡®ä¿ sitemap è·¯ç”±ä¸è¢«é‡å®šå‘
export function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname
  
  // è·³è¿‡ sitemap æ–‡ä»¶
  if (pathname.includes('sitemap') && pathname.endsWith('.xml')) {
    return NextResponse.next()
  }
  
  // ... å…¶ä»–ç°æœ‰é€»è¾‘
}
```

---

## æµ‹è¯•éªŒè¯

### 1. æœ¬åœ°æµ‹è¯•

å¯åŠ¨å¼€å‘æœåŠ¡å™¨åï¼Œè®¿é—®ä»¥ä¸‹ URL è¿›è¡Œæµ‹è¯•ï¼š

```bash
# å¯åŠ¨æœåŠ¡å™¨
npm run dev

# æµ‹è¯• URL
http://localhost:3000/sitemap.xml                      # ä¸»ç´¢å¼•
http://localhost:3000/sitemap-zh-CN.xml                # ç®€ä½“ä¸­æ–‡ç´¢å¼•
http://localhost:3000/sitemap-zh-CN-games.xml          # ç®€ä½“æ¸¸æˆsitemap
http://localhost:3000/sitemap-zh-CN-boxes.xml          # ç®€ä½“ç›’å­sitemap
http://localhost:3000/sitemap-zh-CN-strategy.xml       # ç®€ä½“æ”»ç•¥sitemap
http://localhost:3000/sitemap-zh-TW.xml                # ç¹ä½“ä¸­æ–‡ç´¢å¼•
http://localhost:3000/sitemap-en-US.xml                # è‹±æ–‡ç´¢å¼•
```

### 2. XML æ ¼å¼éªŒè¯

ä½¿ç”¨åœ¨çº¿å·¥å…·éªŒè¯ XML æ ¼å¼ï¼š
- [XML Sitemap Validator](https://www.xml-sitemaps.com/validate-xml-sitemap.html)
- [Google Search Console - Sitemap Report](https://search.google.com/search-console)

### 3. æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰ sitemap æ–‡ä»¶éƒ½èƒ½æ­£å¸¸è®¿é—®
- [ ] XML æ ¼å¼æ­£ç¡®ï¼Œæ²¡æœ‰è¯­æ³•é”™è¯¯
- [ ] URL éƒ½æ˜¯ç»å¯¹è·¯å¾„ï¼ˆåŒ…å«å®Œæ•´åŸŸåï¼‰
- [ ] å¤šè¯­è¨€ hreflang æ ‡ç­¾æ­£ç¡®
- [ ] changefreq å’Œ priority è®¾ç½®åˆç†
- [ ] å•ä¸ªæ–‡ä»¶ URL æ•°é‡ä¸è¶…è¿‡ 50,000
- [ ] æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 50MB
- [ ] lastmod æ—¶é—´æ ¼å¼æ­£ç¡®ï¼ˆISO 8601ï¼‰

### 4. æ€§èƒ½æµ‹è¯•

```bash
# æµ‹è¯•ç”Ÿæˆæ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:3000/sitemap.xml

# curl-format.txt å†…å®¹ï¼š
time_namelookup:  %{time_namelookup}\n
time_connect:  %{time_connect}\n
time_total:  %{time_total}\n
```

ç›®æ ‡ï¼š
- ä¸»ç´¢å¼•ï¼š< 1ç§’
- è¯­è¨€ç´¢å¼•ï¼š< 1ç§’
- å†…å®¹sitemapï¼š< 5ç§’

---

## æäº¤æœç´¢å¼•æ“

### 1. Google Search Console

1. è®¿é—® [Google Search Console](https://search.google.com/search-console)
2. æ·»åŠ ç½‘ç«™å±æ€§ï¼ˆå¦‚æœªæ·»åŠ ï¼‰
3. è¿›å…¥ "ç´¢å¼•" > "ç«™ç‚¹åœ°å›¾"
4. æäº¤ä¸» sitemapï¼š`https://yourdomain.com/sitemap.xml`
5. Google ä¼šè‡ªåŠ¨å‘ç°å’ŒæŠ“å–å­ sitemap

### 2. Bing Webmaster Tools

1. è®¿é—® [Bing Webmaster Tools](https://www.bing.com/webmasters)
2. æ·»åŠ ç½‘ç«™ï¼ˆå¦‚æœªæ·»åŠ ï¼‰
3. è¿›å…¥ "ç«™ç‚¹åœ°å›¾"
4. æäº¤ï¼š`https://yourdomain.com/sitemap.xml`

### 3. å…¶ä»–æœç´¢å¼•æ“

- **Yandex**ï¼š[Yandex Webmaster](https://webmaster.yandex.com/)
- **Baidu**ï¼š[ç™¾åº¦ç«™é•¿å¹³å°](https://ziyuan.baidu.com/)
- **Naver**ï¼ˆéŸ©å›½ï¼‰ï¼š[Naver Webmaster Tools](https://searchadvisor.naver.com/)

### 4. robots.txt

åœ¨ `public/robots.txt` ä¸­æ·»åŠ  sitemap å¼•ç”¨ï¼š

```txt
User-agent: *
Allow: /

Sitemap: https://yourdomain.com/sitemap.xml
```

---

## è¿›é˜¶ä¼˜åŒ–

### 1. å›¾ç‰‡ Sitemap

å¦‚æœæ¸¸æˆ/ç›’å­æœ‰å¤§é‡å›¾ç‰‡ï¼Œå¯ä»¥æ·»åŠ å›¾ç‰‡ sitemapï¼š

```xml
<url>
  <loc>https://yourdomain.com/games/123</loc>
  <image:image>
    <image:loc>https://yourdomain.com/images/game-123.jpg</image:loc>
    <image:caption>æ¸¸æˆæ ‡é¢˜</image:caption>
  </image:image>
</url>
```

### 2. è§†é¢‘ Sitemap

å¦‚æœæœ‰æ¸¸æˆè§†é¢‘ï¼Œå¯ä»¥æ·»åŠ è§†é¢‘ sitemapï¼š

```xml
<url>
  <loc>https://yourdomain.com/games/123</loc>
  <video:video>
    <video:thumbnail_loc>https://yourdomain.com/thumb.jpg</video:thumbnail_loc>
    <video:title>æ¸¸æˆé¢„å‘Šç‰‡</video:title>
    <video:description>æ¸¸æˆä»‹ç»è§†é¢‘</video:description>
  </video:video>
</url>
```

### 3. æ–°é—» Sitemap

å¦‚æœæ”»ç•¥æ–‡ç« å±äºæ–°é—»ç±»ï¼Œå¯ä»¥ä½¿ç”¨æ–°é—» sitemap æ ¼å¼ï¼š

```xml
<url>
  <loc>https://yourdomain.com/strategy/new-game-guide</loc>
  <news:news>
    <news:publication>
      <news:name>GameBox</news:name>
      <news:language>zh-CN</news:language>
    </news:publication>
    <news:publication_date>2025-01-15T10:00:00+00:00</news:publication_date>
    <news:title>æ–°æ¸¸æˆæ”»ç•¥</news:title>
  </news:news>
</url>
```

### 4. å¢é‡æ›´æ–°

å¯¹äºé¢‘ç¹æ›´æ–°çš„å†…å®¹ï¼Œå¯ä»¥å®ç°å¢é‡ sitemapï¼š

```typescript
// ç”Ÿæˆæœ€è¿‘æ›´æ–°çš„å†…å®¹
export async function fetchRecentUpdates(days = 7): Promise<SitemapUrl[]> {
  const since = new Date()
  since.setDate(since.getDate() - days)
  
  // è·å–æœ€è¿‘æ›´æ–°çš„å†…å®¹
  const recentGames = await api.games.list({
    updatedSince: since.toISOString(),
  })
  
  // ... ç”Ÿæˆ URLs
}
```

### 5. ç¼“å­˜ç­–ç•¥

ä½¿ç”¨ Redis æˆ–å…¶ä»–ç¼“å­˜æ¥æé«˜æ€§èƒ½ï¼š

```typescript
import { Redis } from 'ioredis'

const redis = new Redis(process.env.REDIS_URL)

export async function getCachedSitemap(key: string) {
  const cached = await redis.get(key)
  if (cached) return cached
  
  const sitemap = await generateSitemap()
  await redis.setex(key, 3600, sitemap) // ç¼“å­˜1å°æ—¶
  
  return sitemap
}
```

---

## ç›‘æ§å’Œç»´æŠ¤

### 1. å®šæœŸæ£€æŸ¥

- æ¯å‘¨æ£€æŸ¥ Google Search Console çš„ç´¢å¼•çŠ¶æ€
- å…³æ³¨è¦†ç›–ç‡æŠ¥å‘Šå’Œé”™è¯¯
- æ£€æŸ¥ sitemap æ–‡ä»¶çš„æŠ“å–æƒ…å†µ

### 2. æ€§èƒ½ç›‘æ§

```typescript
// æ·»åŠ æ—¥å¿—
console.log(`Generated sitemap for ${locale}-${type}: ${urls.length} URLs`)
console.log(`Generation time: ${Date.now() - startTime}ms`)
```

### 3. é”™è¯¯å¤„ç†

```typescript
export async function generateSitemapWithFallback(
  locale: string,
  type: ContentType
) {
  try {
    return await generateContentSitemap(locale, type)
  } catch (error) {
    console.error('Sitemap generation failed:', error)
    // è¿”å›åŸºç¡€ç‰ˆæœ¬æˆ–ç¼“å­˜ç‰ˆæœ¬
    return getCachedSitemap(`${locale}-${type}`)
  }
}
```

### 4. è‡ªåŠ¨åŒ–æµ‹è¯•

```typescript
// tests/sitemap.test.ts
import { describe, it, expect } from 'vitest'
import { generateSitemapIndex } from '@/lib/sitemap/generator'

describe('Sitemap Generation', () => {
  it('should generate valid sitemap index', async () => {
    const xml = generateSitemapIndex()
    expect(xml).toContain('<?xml version="1.0"')
    expect(xml).toContain('<sitemapindex')
    expect(xml).toContain('sitemap-zh-CN.xml')
  })
  
  it('should include all supported locales', async () => {
    const xml = generateSitemapIndex()
    expect(xml).toContain('sitemap-zh-CN.xml')
    expect(xml).toContain('sitemap-zh-TW.xml')
    expect(xml).toContain('sitemap-en-US.xml')
  })
})
```

---

## æ€»ç»“

### å®æ–½æ—¶é—´ä¼°è®¡

| é˜¶æ®µ | é¢„è®¡æ—¶é—´ | å…³é”®ä»»åŠ¡ |
|------|---------|---------|
| å‡†å¤‡å·¥ä½œ | 1å°æ—¶ | åˆ›å»ºé…ç½®æ–‡ä»¶ã€ç›®å½•ç»“æ„ |
| æ ¸å¿ƒé€»è¾‘ | 3-4å°æ—¶ | å®ç°ç”Ÿæˆå™¨ã€æ ¼å¼åŒ–å™¨ |
| æ•°æ®é›†æˆ | 2-3å°æ—¶ | è¿æ¥ APIã€å¤„ç†å¤šè¯­è¨€ |
| æµ‹è¯•ä¼˜åŒ– | 1-2å°æ—¶ | æœ¬åœ°æµ‹è¯•ã€æ ¼å¼éªŒè¯ |
| **æ€»è®¡** | **7-10å°æ—¶** | |

### å…³é”®æ”¶ç›Š

- âœ… **SEOæå‡**ï¼šå¸®åŠ©æœç´¢å¼•æ“å¿«é€Ÿç´¢å¼•æ‰€æœ‰é¡µé¢
- âœ… **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ­£ç¡®æ ‡è®°è¯­è¨€å˜ä½“ï¼Œé¿å…é‡å¤å†…å®¹é—®é¢˜
- âœ… **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°å†…å®¹ç±»å‹
- âœ… **é«˜æ€§èƒ½**ï¼šç¼“å­˜å’Œåˆ†ç‰‡ç­–ç•¥ï¼Œç¡®ä¿å¿«é€Ÿå“åº”
- âœ… **æ˜“ç»´æŠ¤**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„ï¼Œä¾¿äºåç»­æ›´æ–°

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹**ï¼šæŒ‰ç…§æ­¥éª¤åˆ›å»ºæ–‡ä»¶å’Œç›®å½•
2. **åˆ†é˜¶æ®µå®æ–½**ï¼šå…ˆå®ç°ä¸» sitemapï¼Œå†å®Œå–„ç»†èŠ‚
3. **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®æœç´¢å¼•æ“åé¦ˆè°ƒæ•´é…ç½®
4. **å®šæœŸç›‘æ§**ï¼šå…³æ³¨ç´¢å¼•çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡

---

## å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆè¦åˆ†è¿™ä¹ˆå¤šå±‚ï¼Ÿ
**A**: å¤§å‹ç½‘ç«™å•ä¸ª sitemap æ–‡ä»¶ä¼šéå¸¸å¤§ï¼Œåˆ†å±‚å¯ä»¥ï¼š
- æé«˜åŠ è½½é€Ÿåº¦
- æ–¹ä¾¿æœç´¢å¼•æ“æŠ“å–
- ä¾¿äºç»´æŠ¤å’Œè°ƒè¯•
- ç¬¦åˆ Google çš„æœ€ä½³å®è·µ

### Q2: å¤šä¹…æ›´æ–°ä¸€æ¬¡ sitemapï¼Ÿ
**A**: 
- é™æ€é¡µé¢ï¼šæ¯æ—¥æ›´æ–°
- åŠ¨æ€å†…å®¹ï¼šæ ¹æ®æ›´æ–°é¢‘ç‡ï¼Œæ¯å°æ—¶åˆ°æ¯å‘¨
- ä½¿ç”¨ Next.js çš„ revalidate å¯ä»¥è‡ªåŠ¨æ›´æ–°

### Q3: ç®€ä½“ä¸­æ–‡ï¼ˆé»˜è®¤è¯­è¨€ï¼‰çš„ URL è¦ä¸è¦åŠ å‰ç¼€ï¼Ÿ
**A**: ä¸éœ€è¦ï¼Œä½ çš„é¡¹ç›®ä¸­ zh-CN æ˜¯é»˜è®¤è¯­è¨€ï¼ŒURL æ— å‰ç¼€ï¼ˆå¦‚ `/games/123`ï¼‰ï¼Œå…¶ä»–è¯­è¨€æœ‰å‰ç¼€ï¼ˆå¦‚ `/zh-TW/games/123`ï¼‰ã€‚

### Q4: éœ€è¦ä¸ºæ¯ä¸ªé¡µé¢éƒ½ç”Ÿæˆ sitemap å—ï¼Ÿ
**A**: ä¸éœ€è¦ï¼Œä»¥ä¸‹é¡µé¢é€šå¸¸ä¸åŒ…å«åœ¨ sitemapï¼š
- æœç´¢ç»“æœé¡µ
- ç™»å½•/æ³¨å†Œé¡µ
- API è·¯ç”±
- ç®¡ç†åå°
- 404 é¡µé¢

### Q5: å¦‚ä½•ç¡®ä¿ sitemap ä¸ä¼šå¤ªå¤§ï¼Ÿ
**A**: 
- å•ä¸ªæ–‡ä»¶é™åˆ¶ 45,000 ä¸ª URL
- è¶…è¿‡æ—¶è‡ªåŠ¨åˆ†ç‰‡ï¼ˆå¦‚ sitemap-zh-CN-games-1.xml, sitemap-zh-CN-games-2.xmlï¼‰
- å‹ç¼© sitemap æ–‡ä»¶ï¼ˆ.xml.gzï¼‰

### Q6: æäº¤åå¤šä¹…èƒ½çœ‹åˆ°æ•ˆæœï¼Ÿ
**A**: 
- Googleï¼šé€šå¸¸ 1-7 å¤©å¼€å§‹ç´¢å¼•
- Bingï¼š3-14 å¤©
- ç™¾åº¦ï¼š1-4 å‘¨
- å¯ä»¥åœ¨å„æœç´¢å¼•æ“çš„ Webmaster Tools ä¸­æŸ¥çœ‹ç´¢å¼•è¿›åº¦

---

## å‚è€ƒèµ„æº

- [Google Sitemap åè®®](https://www.sitemaps.org/protocol.html)
- [Google Search Central - Sitemap](https://developers.google.com/search/docs/crawling-indexing/sitemaps/overview)
- [Next.js Sitemap Generation](https://nextjs.org/docs/app/api-reference/functions/generate-sitemaps)
- [Vercel SEO æœ€ä½³å®è·µ](https://vercel.com/docs/concepts/functions/edge-functions/edge-functions-seo)
- [å›½é™…åŒ– SEO æŒ‡å—](https://developers.google.com/search/docs/specialty/international/localized-versions)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-18  
**é€‚ç”¨é¡¹ç›®**: GameBox Next.js å¤šè¯­è¨€æ¸¸æˆå¹³å°
